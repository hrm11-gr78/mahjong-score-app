<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雀ログ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id="app">
        <header style="position: relative; display: flex; align-items: center; justify-content: center;">
            <button id="header-profile-btn"
                style="position: absolute; left: 0; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-primary);"
                title="ユーザー設定">👤</button>
            <h1>🀄 雀ログ</h1>
            <button id="header-settings-btn"
                style="display: none; position: absolute; right: 0; background: none; border: none; font-size: 1.5rem; cursor: pointer;">⚙️</button>
        </header>

        <nav>
            <button data-target="home" class="active">ホーム</button>
            <button data-target="users">ユーザー</button>
            <button data-target="roulette">ルーレット</button>
            <!-- <button data-target="settings">設定</button> Removed as per user request -->
        </nav>

        <main>
            <!-- HOME / SESSION SETUP SECTION -->
            <section id="home" class="active">
                <h2>新規セット</h2>
                <div id="setup-restriction-msg" class="restricted-access-msg"
                    style="display:none; padding:15px; background:rgba(255,165,0,0.1); border:1px solid orange; border-radius:8px; margin-bottom:20px; color:orange;">
                    ⚠️ セットを開始するには、画面左上のユーザーアイコン(👤)から自分の名前を選択してください。<br>
                    (未設定の状態では記録の参照のみ可能です)
                </div>

                <form id="session-setup-form">
                    <div class="form-group">
                        <label>日付</label>
                        <input type="date" id="session-date" required>
                    </div>
                    <div class="form-group">
                        <label>対局者 (4名)</label>
                        <div class="score-grid">
                            <div class="player-select-wrapper" id="p1-wrapper">
                                <select name="p1" class="user-select" required>
                                    <option value="" disabled selected>選択...</option>
                                </select>
                                <input type="text" name="p1_custom" class="user-input-custom" placeholder="名前..."
                                    style="display:none;">
                                <button type="button" class="toggle-guest-btn" data-target="p1"
                                    title="手動入力切替">🖊️</button>
                            </div>
                            <div class="player-select-wrapper" id="p2-wrapper">
                                <select name="p2" class="user-select" required>
                                    <option value="" disabled selected>選択...</option>
                                </select>
                                <input type="text" name="p2_custom" class="user-input-custom" placeholder="名前..."
                                    style="display:none;">
                                <button type="button" class="toggle-guest-btn" data-target="p2"
                                    title="手動入力切替">🖊️</button>
                            </div>
                            <div class="player-select-wrapper" id="p3-wrapper">
                                <select name="p3" class="user-select" required>
                                    <option value="" disabled selected>選択...</option>
                                </select>
                                <input type="text" name="p3_custom" class="user-input-custom" placeholder="名前..."
                                    style="display:none;">
                                <button type="button" class="toggle-guest-btn" data-target="p3"
                                    title="手動入力切替">🖊️</button>
                            </div>
                            <div class="player-select-wrapper" id="p4-wrapper">
                                <select name="p4" class="user-select" required>
                                    <option value="" disabled selected>選択...</option>
                                </select>
                                <input type="text" name="p4_custom" class="user-input-custom" placeholder="名前..."
                                    style="display:none;">
                                <button type="button" class="toggle-guest-btn" data-target="p4"
                                    title="手動入力切替">🖊️</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <details>
                            <summary style="cursor:pointer; color:var(--primary-color); margin-bottom:10px;">ルール設定
                                (このセットのみ)</summary>
                            <div style="padding: 10px; border: 1px solid #333; border-radius: 8px;">
                                <div class="form-group">
                                    <label>配給原点</label>
                                    <input type="number" name="startScore" id="new-set-start" value="25000" step="100">
                                </div>
                                <div class="form-group">
                                    <label>返し点</label>
                                    <input type="number" name="returnScore" id="new-set-return" value="30000"
                                        step="100">
                                </div>
                                <div class="form-group">
                                    <label>ウマ (1位〜4位)</label>
                                    <div class="score-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px;">
                                        <input type="number" name="uma1" id="new-set-uma1" value="30">
                                        <input type="number" name="uma2" id="new-set-uma2" value="10">
                                        <input type="number" name="uma3" id="new-set-uma3" value="-10">
                                        <input type="number" name="uma4" id="new-set-uma4" value="-30">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>同点時の扱い</label>
                                    <div style="display: flex; gap: 20px; align-items: center;">
                                        <label
                                            style="display: flex; align-items: center; margin: 0; color: var(--text-primary);">
                                            <input type="radio" name="newSetTieBreaker" value="priority" checked
                                                style="width: auto; margin-right: 8px;"> 起家優先
                                        </label>
                                        <label
                                            style="display: flex; align-items: center; margin: 0; color: var(--text-primary);">
                                            <input type="radio" name="newSetTieBreaker" value="split"
                                                style="width: auto; margin-right: 8px;"> 山分け
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>
                    <button type="submit" class="btn-primary">セット開始</button>
                </form>

                <h2 class="mt-4">過去のセット</h2>
                <div id="session-list">
                    <!-- Session list injected here -->
                </div>
            </section>

            <!-- SESSION DETAIL SECTION -->
            <section id="session-detail">
                <div class="history-header">
                    <button id="back-to-home" class="btn-secondary">← 戻る</button>
                    <span id="session-title" style="font-weight:bold;"></span>
                </div>

                <!-- Total Score Table -->
                <div class="history-card">
                    <h3>合計スコア</h3>
                    <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <label for="session-rate" style="margin: 0;">レート (点):</label>
                        <select id="session-rate" style="width: auto; padding: 5px;">
                            <option value="0">なし</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div style="position: relative; height: 300px; width: 100%; margin-bottom: 20px;">
                        <canvas id="score-chart"></canvas>
                    </div>
                    <table class="history-table" id="session-total-table">
                        <!-- Totals injected here -->
                    </table>
                </div>

                <div id="game-restriction-msg" class="restricted-access-msg"
                    style="display:none; padding:10px; background:rgba(255,165,0,0.1); border:1px solid orange; border-radius:8px; margin-bottom:20px; color:orange; font-size:0.9rem;">
                    ⚠️ 対局を追加するには、ユーザー設定が必要です。
                </div>
                <button id="new-game-btn" class="btn-primary" style="margin-bottom: 20px;">+ 対局を追加</button>

                <h3>対局履歴</h3>
                <div id="game-list">
                    <!-- Games injected here -->
                </div>
            </section>

            <!-- SCORE INPUT MODAL (Using Section for simplicity) -->
            <section id="input">
                <div class="history-header">
                    <button id="cancel-input" class="btn-secondary">キャンセル</button>
                    <span>スコア入力</span>
                </div>
                <div id="score-restriction-msg" class="restricted-access-msg"
                    style="display:none; padding:10px; background:rgba(255,165,0,0.1); border:1px solid orange; border-radius:8px; margin-bottom:20px; color:orange; font-size:0.9rem;">
                    ⚠️ 対局結果を保存するには、ユーザー設定が必要です。
                </div>
                <form id="score-form">
                    <div class="score-grid">
                        <!-- Player 1 -->
                        <div class="player-input">
                            <label id="lbl-p1">Player 1</label>
                            <input type="hidden" name="p1-name" id="inp-p1-name">
                            <div class="input-wrapper">
                                <input type="number" name="p1-score" placeholder="250" required>
                                <span class="suffix">00</span>
                            </div>
                        </div>
                        <!-- Player 2 -->
                        <div class="player-input">
                            <label id="lbl-p2">Player 2</label>
                            <input type="hidden" name="p2-name" id="inp-p2-name">
                            <div class="input-wrapper">
                                <input type="number" name="p2-score" placeholder="250" required>
                                <span class="suffix">00</span>
                            </div>
                        </div>
                        <!-- Player 3 -->
                        <div class="player-input">
                            <label id="lbl-p3">Player 3</label>
                            <input type="hidden" name="p3-name" id="inp-p3-name">
                            <div class="input-wrapper">
                                <input type="number" name="p3-score" placeholder="250" required>
                                <span class="suffix">00</span>
                            </div>
                        </div>
                        <!-- Player 4 -->
                        <div class="player-input">
                            <label id="lbl-p4">Player 4</label>
                            <input type="hidden" name="p4-name" id="inp-p4-name">
                            <div class="input-wrapper">
                                <input type="number" name="p4-score" placeholder="250" required>
                                <span class="suffix">00</span>
                            </div>
                        </div>
                    </div>

                    <div class="total-check" id="total-check">合計: 0</div>

                    <button type="submit" class="btn-primary">計算して保存</button>
                </form>
            </section>

            <!-- SETTINGS SECTION -->
            <section id="settings">
                <h2>ルール設定</h2>
                <div id="settings-restriction-msg" class="restricted-access-msg"
                    style="display:none; padding:15px; background:rgba(255,165,0,0.1); border:1px solid orange; border-radius:8px; margin-bottom:20px; color:orange;">
                    ⚠️ ルール設定を変更するには、ユーザー設定が必要です。
                </div>
                <form id="settings-form">
                    <div class="form-group">
                        <label>配給原点</label>
                        <input type="number" id="set-start" value="25000" step="100">
                    </div>
                    <div class="form-group">
                        <label>返し点</label>
                        <input type="number" id="set-return" value="30000" step="100">
                    </div>
                    <div class="form-group">
                        <label>ウマ (1位〜4位)</label>
                        <div class="score-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px;">
                            <input type="number" id="set-uma1" value="30">
                            <input type="number" id="set-uma2" value="10">
                            <input type="number" id="set-uma3" value="-10">
                            <input type="number" id="set-uma4" value="-30">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>同点時の扱い</label>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <label style="display: flex; align-items: center; margin: 0; color: var(--text-primary);">
                                <input type="radio" name="tieBreaker" value="priority" checked
                                    style="width: auto; margin-right: 8px;"> 起家優先
                            </label>
                            <label style="display: flex; align-items: center; margin: 0; color: var(--text-primary);">
                                <input type="radio" name="tieBreaker" value="split"
                                    style="width: auto; margin-right: 8px;"> 山分け
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">設定を保存</button>
                    <button type="button" id="reset-settings" class="btn-danger"
                        style="margin-top:10px;">初期値に戻す</button>
                </form>
            </section>

            <!-- USERS SECTION -->
            <section id="users">
                <h2>ユーザー管理</h2>
                <div class="form-group">
                    <input type="text" id="new-user-name" placeholder="名前を入力...">
                </div>
                <button id="add-user-btn" class="btn-primary" style="margin-bottom: 20px;">ユーザー追加</button>

                <h3>登録ユーザー</h3>
                <ul id="user-list" class="user-list">
                    <!-- Users will be injected here -->
                </ul>
            </section>

            <!-- ROULETTE SECTION -->
            <section id="roulette">
                <h2>ルーレット</h2>

                <div class="roulette-container">
                    <div class="canvas-wrapper">
                        <canvas id="roulette-canvas" width="300" height="300"></canvas>
                        <div class="roulette-arrow">▼</div>
                    </div>

                    <div class="roulette-controls">
                        <button id="spin-btn" class="btn-primary">スタート！</button>
                        <div id="roulette-result" class="roulette-result"></div>
                    </div>
                </div>

                <div class="roulette-setup">
                    <h3>項目設定 <span style="font-size:0.8rem; font-weight:normal;">(最大20個)</span></h3>
                    <div id="roulette-restriction-msg" class="restricted-access-msg"
                        style="display:none; padding:10px; background:rgba(255,165,0,0.1); border:1px solid orange; border-radius:8px; margin-bottom:20px; color:orange; font-size:0.9rem;">
                        ⚠️ ルーレットを操作するには、ユーザー設定が必要です。
                    </div>
                    <div class="form-group" style="display:flex; gap:10px;">
                        <input type="text" id="roulette-input" placeholder="項目を入力 (例: 東場, 南場...)">
                        <button id="add-roulette-item" class="btn-secondary"
                            style="width:auto; white-space:nowrap;">追加</button>
                    </div>
                    <ul id="roulette-list" class="roulette-list">
                        <!-- Items injected here -->
                    </ul>
                </div>
            </section>

            <!-- USER DETAIL SECTION -->
            <section id="user-detail">
                <div class="history-header">
                    <button id="back-to-users" class="btn-secondary">← 戻る</button>
                    <span id="user-detail-name" style="font-weight:bold;"></span>
                </div>

                <div id="cumulative-score-card" class="history-card"
                    style="text-align: center; padding: 40px 30px; margin-bottom: 25px; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border: 2px solid #475569; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); position: relative; overflow: hidden;">
                    <!-- Background decoration -->
                    <div
                        style="position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, transparent 70%); pointer-events: none;">
                    </div>

                    <div style="position: relative; z-index: 1;">
                        <div
                            style="font-size: 1rem; color: #e2e8f0; margin-bottom: 16px; letter-spacing: 1px; text-transform: uppercase; font-weight: 600; padding: 8px 20px; border: 2px solid rgba(226, 232, 240, 0.3); border-radius: 20px; display: inline-block;">
                            累計スコア</div>

                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                            <div id="score-icon"
                                style="font-size: 2.5rem; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));">🎯</div>
                            <div
                                style="font-size: 4rem; font-weight: 800; line-height: 1; text-shadow: 0 4px 12px rgba(0,0,0,0.4);">
                                <span id="user-total-score">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="history-card">
                    <h3>セット履歴</h3>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>スコア</th>
                                <th>収支</th>
                                <th style="font-size:0.8em">1着</th>
                                <th style="font-size:0.8em">2着</th>
                                <th style="font-size:0.8em">3着</th>
                                <th style="font-size:0.8em">4着</th>
                            </tr>
                        </thead>
                        <tbody id="user-history-list">
                            <!-- History injected here -->
                        </tbody>
                    </table>

                </div>
    </div>

    <!-- Tie Breaker Modal -->
    <div id="tie-breaker-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>同点順位の決定</h3>
            <p>起家(東家)に近いプレイヤーを選択してください。</p>
            <div id="tie-breaker-options"></div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="user-profile-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 style="margin-top: 0;">ユーザー設定</h3>

            <div class="form-group">
                <label style="font-size: 1rem; font-weight: 600;">ユーザー名</label>
                <select id="profile-user-select" class="user-select"
                    style="width: 100%; padding: 12px; font-size: 1rem;">
                    <option value="">(未選択)</option>
                </select>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                <button id="close-profile-modal" class="btn-secondary" style="width: auto;">キャンセル</button>
                <button id="save-profile-user" class="btn-primary" style="width: auto;">保存</button>
            </div>
        </div>
    </div>

    <!-- Firebase Compat (Global) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="sw.js"></script>
    <script src="js/mahjong.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/app.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, (err) => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>

</html>