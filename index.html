<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雀ログ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>

<body>
    <div id="app">
        <header style="position: relative; display: flex; align-items: center; justify-content: center;">
            <button id="header-profile-btn" class="header-icon" style="display: none;" title="ユーザー設定">👤</button>
            <h1 id="app-title" style="cursor: pointer;">🀄 雀ログ</h1>
            <!-- Added League Button next to Settings -->
            <button id="header-league-btn" class="header-icon" style="display: none;" title="リーグ戦">🏆</button>
            <button id="header-settings-btn" class="header-icon" style="display: none;">⚙️</button>
            <!-- [NEW] Gallery Button in Header -->
            <button id="header-gallery-btn" class="header-icon" style="display: none;">🖼️</button>
        </header>

        <nav style="display: none;">
            <button data-target="home" class="active">セット</button>
            <button data-target="users">ユーザー</button>
            <button data-target="roulette">ルーレット</button>
            <!-- Gallery moved to header -->
            <!-- League moved to header -->
        </nav>

        <!-- ローディング画面: Auth確認完了まで表示 -->
        <div id="loading-screen">
            <div class="loading-logo">🀄 雀ログ</div>
            <div class="loading-spinner"></div>
        </div>

        <main>
            <!-- LOGIN SECTION -->
            <section id="login">
                <h2>ログイン</h2>
                <div class="form-group">
                    <label>メールアドレス</label>
                    <input type="email" id="login-email" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>パスワード</label>
                    <input type="password" id="login-password" placeholder="Password">
                </div>
                <button id="login-btn" class="btn-primary" style="margin-bottom: 10px;">ログイン</button>
                <div style="display:flex; align-items:center; margin: 15px 0;">
                    <hr style="flex:1; border:none; border-top:1px solid #333;">
                    <span style="padding:0 10px; color:#666; font-size:0.8rem;">または</span>
                    <hr style="flex:1; border:none; border-top:1px solid #333;">
                </div>
                <button id="google-login-btn" class="btn-secondary"
                    style="width:100%; border-color:#4285F4; color:#4285F4; margin-bottom:10px;">
                    <span style="font-weight:bold;">G</span> Googleでログイン
                </button>
                <div class="text-center" style="margin-top: 15px;">
                    <button id="show-signup" class="btn-secondary" style="font-size: 0.9rem;">アカウントを作成する</button>
                </div>
                <div id="login-error" class="error-msg"
                    style="display:none; color: var(--error-color); margin-top: 10px;"></div>
            </section>

            <!-- SIGNUP SECTION (Hidden by default) -->
            <section id="signup">
                <h2>アカウント作成</h2>
                <div class="form-group">
                    <label>メールアドレス</label>
                    <input type="email" id="signup-email" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>パスワード</label>
                    <input type="password" id="signup-password" placeholder="Password">
                </div>
                <button id="signup-btn" class="btn-primary" style="margin-bottom: 10px;">アカウントを作成する</button>
                <div style="display:flex; align-items:center; margin: 15px 0;">
                    <hr style="flex:1; border:none; border-top:1px solid #333;">
                    <span style="padding:0 10px; color:#666; font-size:0.8rem;">または</span>
                    <hr style="flex:1; border:none; border-top:1px solid #333;">
                </div>
                <button id="google-signup-btn" class="btn-secondary"
                    style="width:100%; border-color:#4285F4; color:#4285F4; margin-bottom:10px;">
                    <span style="font-weight:bold;">G</span> Googleで登録
                </button>
                <div class="text-center" style="margin-top: 15px;">
                    <button id="show-login" class="btn-secondary" style="font-size: 0.9rem;">ログイン画面に戻る</button>
                </div>
                <div id="signup-error" class="error-msg"
                    style="display:none; color: var(--error-color); margin-top: 10px;"></div>
            </section>


            <!-- LINK USER SECTION -->
            <section id="link-user">
                <h2>ユーザー名を設定</h2>
                <p style="margin-bottom: 20px;">アプリで使用するあなたの名前を入力してください。</p>
                <div class="form-group">
                    <label>ユーザー名</label>
                    <input type="text" id="link-user-new-name" placeholder="例：タロウ">
                </div>
                <button id="link-user-btn" class="btn-primary">はじめる</button>
            </section>

            <!-- SETTINGS SECTION -->
            <section id="settings-section" class="content-section" style="display: none;">
                <!-- Settings content will be rendered here -->
            </section>

            <!-- LEAGUE SECTION -->
            <section id="league-section" class="content-section" style="display: none;">
                <!-- League content rendered by js/league.js -->
            </section>

            <!-- HOME / SESSION SETUP SECTION -->
            <section id="home">
                <h2>新規セット</h2>
                <div id="setup-restriction-msg" class="restricted-access-msg"
                    style="display:none; padding:15px; background:rgba(255,165,0,0.1); border:1px solid orange; border-radius:8px; margin-bottom:20px; color:orange;">
                    ⚠️ セットを開始するには、画面左上のユーザーアイコン(👤)から自分の名前を選択してください。<br>
                    (未設定の状態では記録の参照のみ可能です)
                </div>

                <form id="session-setup-form">
                    <div class="form-group">
                        <label>日付</label>
                        <input type="date" id="session-date" required>
                    </div>
                    <div class="form-group">
                        <label>対局者 (4名)</label>
                        <div class="score-grid">
                            <div class="player-select-wrapper" id="p1-wrapper">
                                <select name="p1" class="user-select" required>
                                    <option value="" disabled selected>選択...</option>
                                </select>
                                <input type="text" name="p1_custom" class="user-input-custom" placeholder="名前..."
                                    style="display:none;">
                                <button type="button" class="toggle-guest-btn" data-target="p1"
                                    title="手動入力切替">🖊️</button>
                            </div>
                            <div class="player-select-wrapper" id="p2-wrapper">
                                <select name="p2" class="user-select" required>
                                    <option value="" disabled selected>選択...</option>
                                </select>
                                <input type="text" name="p2_custom" class="user-input-custom" placeholder="名前..."
                                    style="display:none;">
                                <button type="button" class="toggle-guest-btn" data-target="p2"
                                    title="手動入力切替">🖊️</button>
                            </div>
                            <div class="player-select-wrapper" id="p3-wrapper">
                                <select name="p3" class="user-select" required>
                                    <option value="" disabled selected>選択...</option>
                                </select>
                                <input type="text" name="p3_custom" class="user-input-custom" placeholder="名前..."
                                    style="display:none;">
                                <button type="button" class="toggle-guest-btn" data-target="p3"
                                    title="手動入力切替">🖊️</button>
                            </div>
                            <div class="player-select-wrapper" id="p4-wrapper">
                                <select name="p4" class="user-select" required>
                                    <option value="" disabled selected>選択...</option>
                                </select>
                                <input type="text" name="p4_custom" class="user-input-custom" placeholder="名前..."
                                    style="display:none;">
                                <button type="button" class="toggle-guest-btn" data-target="p4"
                                    title="手動入力切替">🖊️</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <details>
                            <summary style="cursor:pointer; color:var(--primary-color); margin-bottom:10px;">ルール設定
                                (このセットのみ)</summary>
                            <div style="padding: 10px; border: 1px solid #333; border-radius: 8px;">
                                <div class="form-group">
                                    <label>配給原点</label>
                                    <input type="number" name="startScore" id="new-set-start" value="25000" step="100">
                                </div>
                                <div class="form-group">
                                    <label>返し点</label>
                                    <input type="number" name="returnScore" id="new-set-return" value="30000"
                                        step="100">
                                </div>
                                <div class="form-group">
                                    <label>ウマ (1位〜4位)</label>
                                    <div class="score-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px;">
                                        <input type="number" name="uma1" id="new-set-uma1" value="30">
                                        <input type="number" name="uma2" id="new-set-uma2" value="10">
                                        <input type="number" name="uma3" id="new-set-uma3" value="-10">
                                        <input type="number" name="uma4" id="new-set-uma4" value="-30">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>同点時の扱い</label>
                                    <div style="display: flex; gap: 20px; align-items: center;">
                                        <label
                                            style="display: flex; align-items: center; margin: 0; color: var(--text-primary);">
                                            <input type="radio" name="newSetTieBreaker" value="priority" checked
                                                style="width: auto; margin-right: 8px;"> 起家優先
                                        </label>
                                        <label
                                            style="display: flex; align-items: center; margin: 0; color: var(--text-primary);">
                                            <input type="radio" name="newSetTieBreaker" value="split"
                                                style="width: auto; margin-right: 8px;"> 山分け
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>
                    <button type="submit" class="btn-primary">セット開始</button>
                </form>

                <h2 class="mt-4">過去のセット</h2>
                <div id="session-list">
                    <!-- Session list injected here -->
                </div>
            </section>

            <!-- SESSION DETAIL SECTION -->
            <section id="session-detail">
                <div class="history-header">
                    <button id="back-to-home" class="btn-secondary">← 戻る</button>
                    <span id="session-title" style="font-weight:bold;"></span>
                </div>

                <!-- Total Score Table -->
                <div class="history-card">
                    <h3>合計スコア</h3>
                    <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <label for="session-rate" style="margin: 0;">レート (点):</label>
                        <select id="session-rate" style="width: auto; padding: 5px;">
                            <option value="0">なし</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div style="position: relative; height: 300px; width: 100%; margin-bottom: 20px;">
                        <canvas id="score-chart"></canvas>
                    </div>
                    <table class="history-table" id="session-total-table">
                        <!-- Totals injected here -->
                    </table>
                </div>

                <div id="game-restriction-msg" class="restricted-access-msg"
                    style="display:none; padding:10px; background:rgba(255,165,0,0.1); border:1px solid orange; border-radius:8px; margin-bottom:20px; color:orange; font-size:0.9rem;">
                    ⚠️ 対局を追加するには、ユーザー設定が必要です。
                </div>
                <button id="new-game-btn" class="btn-primary" style="margin-bottom: 20px;">+ 対局を追加</button>

                <h3>対局履歴</h3>
                <div id="game-list">
                    <!-- Games injected here -->
                </div>
            </section>

            <!-- SCORE INPUT MODAL (Using Section for simplicity) -->
            <section id="input">
                <div class="history-header">
                    <button id="cancel-input" class="btn-secondary">キャンセル</button>
                    <span>スコア入力</span>
                </div>

                <!-- Mode Toggle -->
                <div style="display:flex; justify-content:center; margin-bottom:15px; gap:10px;">
                    <button type="button" id="mode-points" class="btn-primary"
                        style="font-size:0.9rem; padding:5px 15px;">点数入力 (自動計算)</button>
                    <button type="button" id="mode-direct" class="btn-secondary"
                        style="font-size:0.9rem; padding:5px 15px;">スコア直接入力</button>
                </div>

                <!-- Yakuman Button Moved Below -->

                <div id="score-restriction-msg" class="restricted-access-msg"
                    style="display:none; padding:10px; background:rgba(255,165,0,0.1); border:1px solid orange; border-radius:8px; margin-bottom:20px; color:orange; font-size:0.9rem;">
                    ⚠️ 対局結果を保存するには、ユーザー設定が必要です。
                </div>
                <form id="score-form">
                    <div class="score-grid">
                        <!-- Player 1 -->
                        <div class="player-input">
                            <label id="lbl-p1">Player 1</label>
                            <input type="hidden" name="p1-name" id="inp-p1-name">
                            <div class="input-wrapper">
                                <select name="p1-wind"
                                    style="width: 50px; margin-right: 5px; padding: 5px; border-radius: 4px; background: #334155; color: white; border: 1px solid #475569;">
                                    <option value="">-</option>
                                    <option value="東">東</option>
                                    <option value="南">南</option>
                                    <option value="西">西</option>
                                    <option value="北">北</option>
                                </select>
                                <input type="number" name="p1-score" placeholder="250" required>
                                <span class="suffix">00</span>
                            </div>
                        </div>
                        <!-- Player 2 -->
                        <div class="player-input">
                            <label id="lbl-p2">Player 2</label>
                            <input type="hidden" name="p2-name" id="inp-p2-name">
                            <div class="input-wrapper">
                                <select name="p2-wind"
                                    style="width: 50px; margin-right: 5px; padding: 5px; border-radius: 4px; background: #334155; color: white; border: 1px solid #475569;">
                                    <option value="">-</option>
                                    <option value="東">東</option>
                                    <option value="南">南</option>
                                    <option value="西">西</option>
                                    <option value="北">北</option>
                                </select>
                                <input type="number" name="p2-score" placeholder="250" required>
                                <span class="suffix">00</span>
                            </div>
                        </div>
                        <!-- Player 3 -->
                        <div class="player-input">
                            <label id="lbl-p3">Player 3</label>
                            <input type="hidden" name="p3-name" id="inp-p3-name">
                            <div class="input-wrapper">
                                <select name="p3-wind"
                                    style="width: 50px; margin-right: 5px; padding: 5px; border-radius: 4px; background: #334155; color: white; border: 1px solid #475569;">
                                    <option value="">-</option>
                                    <option value="東">東</option>
                                    <option value="南">南</option>
                                    <option value="西">西</option>
                                    <option value="北">北</option>
                                </select>
                                <input type="number" name="p3-score" placeholder="250" required>
                                <span class="suffix">00</span>
                            </div>
                        </div>
                        <!-- Player 4 -->
                        <div class="player-input">
                            <label id="lbl-p4">Player 4</label>
                            <input type="hidden" name="p4-name" id="inp-p4-name">
                            <div class="input-wrapper">
                                <select name="p4-wind"
                                    style="width: 50px; margin-right: 5px; padding: 5px; border-radius: 4px; background: #334155; color: white; border: 1px solid #475569;">
                                    <option value="">-</option>
                                    <option value="東">東</option>
                                    <option value="南">南</option>
                                    <option value="西">西</option>
                                    <option value="北">北</option>
                                </select>
                                <input type="number" name="p4-score" placeholder="250" required>
                                <span class="suffix">00</span>
                            </div>
                        </div>
                    </div>

                    <div class="total-check" id="total-check">合計: 0</div>

                    <button type="submit" class="btn-primary" style="margin-bottom: 15px;">計算して保存</button>

                    <div style="text-align: right;">
                        <button type="button" id="open-yakuman-modal-btn"
                            style="background: none; border: none; color: #ffd700; font-size: 0.9rem; cursor: pointer; text-decoration: underline;">
                            🌸 役満達成を記録する
                        </button>
                    </div>
                </form>
            </section>

            <!-- SETTINGS SECTION -->
            <section id="settings">
                <h2>ルール設定</h2>
                <div id="settings-restriction-msg" class="restricted-access-msg"
                    style="display:none; padding:15px; background:rgba(255,165,0,0.1); border:1px solid orange; border-radius:8px; margin-bottom:20px; color:orange;">
                    ⚠️ ルール設定を変更するには、ユーザー設定が必要です。
                </div>
                <form id="settings-form">
                    <div class="form-group">
                        <label>配給原点</label>
                        <input type="number" id="set-start" value="25000" step="100">
                    </div>
                    <div class="form-group">
                        <label>返し点</label>
                        <input type="number" id="set-return" value="30000" step="100">
                    </div>
                    <div class="form-group">
                        <label>ウマ (1位〜4位)</label>
                        <div class="score-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px;">
                            <input type="number" id="set-uma1" value="30">
                            <input type="number" id="set-uma2" value="10">
                            <input type="number" id="set-uma3" value="-10">
                            <input type="number" id="set-uma4" value="-30">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>同点時の扱い</label>
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <label style="display: flex; align-items: center; margin: 0; color: var(--text-primary);">
                                <input type="radio" name="tieBreaker" value="priority" checked
                                    style="width: auto; margin-right: 8px;"> 起家優先
                            </label>
                            <label style="display: flex; align-items: center; margin: 0; color: var(--text-primary);">
                                <input type="radio" name="tieBreaker" value="split"
                                    style="width: auto; margin-right: 8px;"> 山分け
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">設定を保存</button>
                    <button type="button" id="reset-settings" class="btn-danger"
                        style="margin-top:10px;">初期値に戻す</button>
                </form>
            </section>

            <!-- USERS SECTION -->
            <section id="users">
                <h2>ユーザー管理</h2>
                <div class="form-group">
                    <input type="text" id="new-user-name" placeholder="名前を入力...">
                </div>
                <button id="add-user-btn" class="btn-primary" style="margin-bottom: 20px;">ユーザー追加</button>

                <h3>登録ユーザー</h3>
                <ul id="user-list" class="user-list">
                    <!-- Users will be injected here -->
                </ul>
            </section>

            <!-- ROULETTE SECTION -->
            <section id="roulette">
                <h2>ルーレット</h2>

                <div class="roulette-container">
                    <div class="canvas-wrapper">
                        <canvas id="roulette-canvas" width="300" height="300"></canvas>
                        <div class="roulette-arrow">▼</div>
                    </div>

                    <div class="roulette-controls">
                        <button id="spin-btn" class="btn-primary">スタート！</button>
                        <div id="roulette-result" class="roulette-result"></div>
                    </div>
                </div>

                <div class="roulette-setup">
                    <h3>項目設定 <span style="font-size:0.8rem; font-weight:normal;">(最大20個)</span></h3>
                    <div id="roulette-restriction-msg" class="restricted-access-msg"
                        style="display:none; padding:10px; background:rgba(255,165,0,0.1); border:1px solid orange; border-radius:8px; margin-bottom:20px; color:orange; font-size:0.9rem;">
                        ⚠️ ルーレットを操作するには、ユーザー設定が必要です。
                    </div>
                    <div class="form-group" style="display:flex; gap:10px;">
                        <input type="text" id="roulette-input" placeholder="項目を入力 (例: 東場, 南場...)">
                        <button id="add-roulette-item" class="btn-secondary"
                            style="width:auto; white-space:nowrap;">追加</button>
                    </div>
                    <ul id="roulette-list" class="roulette-list">
                        <!-- Items injected here -->
                    </ul>
                </div>
            </section>

            <!-- GALLERY SECTION -->
            <section id="gallery">
                <div class="content-header">
                    <h2 style="display: flex; align-items: center; gap: 10px;">
                        <span>🌸</span> 役満ギャラリー
                    </h2>
                </div>
                <div id="gallery-list"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding-bottom: 80px;">
                    <!-- Gallery Items Injected Here -->
                </div>
            </section>


            <!-- USER DETAIL SECTION -->
            <section id="user-detail">
                <div class="history-header">
                    <button id="back-to-users" class="btn-secondary">← 戻る</button>
                    <div style="text-align: right;">
                        <div id="user-detail-name" style="font-weight:bold; font-size: 1.1rem;"></div>
                    </div>
                </div>

                <!-- 期間フィルター -->
                <div id="user-detail-period-filter" style="margin-bottom: 16px;"></div>

                <div id="cumulative-score-card" class="history-card"
                    style="text-align: center; padding: 40px 30px; margin-bottom: 25px; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border: 2px solid #475569; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); position: relative; overflow: hidden;">
                    <!-- Background decoration -->
                    <div
                        style="position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, transparent 70%); pointer-events: none;">
                    </div>

                    <div style="position: relative; z-index: 1;">
                        <div
                            style="font-size: 1rem; color: #e2e8f0; margin-bottom: 16px; letter-spacing: 1px; text-transform: uppercase; font-weight: 600; padding: 8px 20px; border: 2px solid rgba(226, 232, 240, 0.3); border-radius: 20px; display: inline-block;">
                            累計スコア</div>

                        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                            <div id="score-icon"
                                style="font-size: 2.5rem; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));">🎯</div>
                            <div
                                style="font-size: 4rem; font-weight: 800; line-height: 1; text-shadow: 0 4px 12px rgba(0,0,0,0.4);">
                                <span id="user-total-score">0</span>
                            </div>
                        </div>
                        <!-- スパークライングラフ用プレースホルダー -->
                        <div id="score-sparkline-container"></div>
                    </div>
                </div>

                <div class="history-card">
                    <h3>セット履歴</h3>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>スコア</th>
                                <th>収支</th>
                                <th style="font-size:0.8em">1着</th>
                                <th style="font-size:0.8em">2着</th>
                                <th style="font-size:0.8em">3着</th>
                                <th style="font-size:0.8em">4着</th>
                            </tr>
                        </thead>
                        <tbody id="user-history-list">
                            <!-- History injected here -->
                        </tbody>
                    </table>

                </div>
    </div>

    <!-- Tie Breaker Modal -->
    <div id="tie-breaker-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>同点順位の決定</h3>
            <p>起家(東家)に近いプレイヤーを選択してください。</p>
            <div id="tie-breaker-options"></div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="user-profile-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 style="margin-top: 0;">アカウント情報</h3>

            <div class="form-group">
                <label style="font-size: 0.9rem; color: var(--text-secondary);">ユーザー名</label>
                <div id="profile-game-name"
                    style="font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: var(--text-primary);">
                </div>

                <label style="font-size: 0.9rem; color: var(--text-secondary);">メールアドレス</label>
                <div id="profile-email" style="font-size: 1rem; margin-bottom: 15px; color: var(--text-primary);"></div>

                <!-- Password Change Toggle -->
                <button id="show-password-change" class="btn-secondary"
                    style="font-size: 0.9rem; padding: 8px 12px; margin-bottom: 10px;">パスワードを変更する</button>

                <!-- Password Change Form (Hidden by default) -->
                <div id="password-change-form"
                    style="display: none; margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                    <label style="font-size: 0.9rem;">新しいパスワード (6文字以上)</label>
                    <input type="password" id="new-password-input" placeholder="New Password"
                        style="margin-top: 5px; margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button id="cancel-password-change" class="btn-secondary"
                            style="font-size: 0.9rem;">キャンセル</button>
                        <button id="update-password-btn" class="btn-primary" style="font-size: 0.9rem;">変更を保存</button>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: space-between; margin-top: 25px;">
                <button id="close-profile-modal" class="btn-secondary" style="width: auto;">閉じる</button>
                <button id="sign-out-btn" class="btn-danger" style="width: auto;">サインアウト</button>
            </div>
        </div>
    </div>

    <!-- Yakuman Registration Modal -->
    <div id="yakuman-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 style="margin-top: 0; color: #ffd700;">🌸 役満登録</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">達成者</label>
                <select id="yakuman-player-select"
                    style="width: 100%; padding: 10px; background: #0f172a; color: #fff; border: 1px solid #334155; border-radius: 4px;">
                    <!-- Populated dynamically from current game players -->
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">役満の種類</label>
                <input type="text" id="yakuman-type-input" list="yakuman-list" placeholder="例: 国士無双"
                    style="width: 100%; padding: 10px; background: #0f172a; color: #fff; border: 1px solid #334155; border-radius: 4px;">
                <datalist id="yakuman-list">
                    <option value="国士無双">
                    <option value="四暗刻">
                    <option value="大三元">
                    <option value="字一色">
                    <option value="緑一色">
                    <option value="清老頭">
                    <option value="四喜和">
                    <option value="九蓮宝燈">
                    <option value="天和">
                    <option value="地和">
                    <option value="数え役満">
                </datalist>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">記念写真 (任意)</label>
                <input type="file" id="yakuman-image-input" accept="image/*"
                    style="width: 100%; padding: 10px; background: #0f172a; color: #fff; border: 1px solid #334155; border-radius: 4px;">
                <div id="yakuman-image-preview" style="margin-top: 10px; text-align: center; display: none;">
                    <img src=""
                        style="max-width: 100%; max-height: 200px; border-radius: 4px; border: 1px solid #334155;">
                </div>
                <!-- Progress Bar -->
                <div id="yakuman-upload-progress-container"
                    style="display: none; margin-top: 10px; background: #334155; border-radius: 4px; height: 10px; overflow: hidden;">
                    <div id="yakuman-upload-progress-bar"
                        style="width: 0%; height: 100%; background: linear-gradient(90deg, #ffd700, #ffa500); transition: width 0.2s;">
                    </div>
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px;">コメント</label>
                <textarea id="yakuman-comment-input" placeholder="喜びの一言..."
                    style="width: 100%; padding: 10px; background: #0f172a; color: #fff; border: 1px solid #334155; border-radius: 4px; height: 60px;"></textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="close-yakuman-modal" class="btn-secondary">キャンセル</button>
                <button id="save-yakuman-btn" class="btn-primary"
                    style="background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%); color: #000; font-weight: bold;">登録する</button>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="image-viewer-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; flex-direction: column;">
        <span id="close-image-viewer"
            style="position: absolute; top: 20px; right: 20px; color: #fff; font-size: 40px; cursor: pointer; z-index: 2001;">&times;</span>
        <img id="image-viewer-img" src=""
            style="max-width: 95%; max-height: 90vh; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
    </div>





    <!-- Firebase Compat (Global) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>


    <script src="sw.js"></script>
    <script src="js/mahjong.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/settlement.js"></script>
    <script src="js/league.js"></script>
    <script src="js/share.js"></script>
    <script src="js/app.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, (err) => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>

</html>